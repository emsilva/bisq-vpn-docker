services:
  gluetun:
    image: qmcgaw/gluetun:v3.40.1
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # VPN testing port (was 8000:8000; removed to avoid port clashes and exposure)
      # Bisq noVNC web interface
      - 6080:6080
      # VNC direct access (optional)
      - 5901:5901
    volumes:
      - ./volumes/gluetun:/gluetun
    env_file:
      - .env
    environment:
      - LOG_LEVEL=warn
      - HEALTH_SERVER_ADDRESS=127.0.0.1:9999
      # Control server kept internal; change or publish only if needed
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - HTTP_CONTROL_SERVER_LOG=off
      - WIREGUARD_PRIVATE_KEY_SECRETFILE=/gluetun/secrets/wg_private_key
      - WIREGUARD_PRESHARED_KEY_SECRETFILE=/gluetun/secrets/wg_preshared_key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ip link show tun0 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Resource limits for VPN container (honored by docker compose)
    mem_limit: 512m
    mem_reservation: 128m
    cpus: 1.0
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=gluetun,component=vpn"
    # Security configuration
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for VPN functionality
      - apparmor:unconfined  # Required for network operations

  bisq:
    build:
      context: docker/bisq
      dockerfile: Dockerfile
      args:
        - BISQ_VERSION=${BISQ_VERSION:-1.9.21}
    container_name: bisq
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      # Main Bisq data directory - contains wallet, trade history, tor hidden service, etc.
      - ./volumes/bisq-data:/home/bisq/.local/share/Bisq
      # XFCE and application configs
      - ./volumes/bisq-config:/home/bisq/.config
    environment:
      - DISPLAY=:1
      - VNC_PASSWORD=${VNC_PASSWORD:-bisqvnc}
      - TZ=${TZ:-America/Sao_Paulo}
      - JAVA_TOOL_OPTIONS=-Xmx3g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ExitOnOutOfMemoryError
      # User/Group ID mapping (defaults to 1000:1000)
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    stdin_open: true
    tty: true
    restart: unless-stopped
    # Resource limits for Bisq application container
    mem_limit: 4g
    mem_reservation: 1g
    cpus: 4.0
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "10"
        labels: "service=bisq,component=application"
    # Security configuration
    security_opt:
      - no-new-privileges:true
      # - seccomp=./security/bisq-seccomp.json  # Temporarily disabled for init system compatibility
    # Additional security hardening
    read_only: false  # Cannot be read-only due to Bisq data writes
    tmpfs:
      - /tmp:noexec,nosuid,size=512m
      - /var/tmp:noexec,nosuid,size=256m
