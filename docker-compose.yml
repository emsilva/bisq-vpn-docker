services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # VPN testing port
      - 8000:8000
      # Bisq noVNC web interface
      - 6080:6080
      # VNC direct access (optional)
      - 5901:5901
    volumes:
      - ./volumes/gluetun:/gluetun
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ip link show tun0 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  bisq:
    build:
      context: docker/bisq
      dockerfile: Dockerfile
      args:
        - BISQ_VERSION=${BISQ_VERSION:-1.9.21}
    container_name: bisq
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      # Main Bisq data directory - contains wallet, trade history, tor hidden service, etc.
      - ./volumes/bisq-data:/home/bisq/.local/share/Bisq
      # XFCE and application configs
      - ./volumes/bisq-config:/home/bisq/.config
    environment:
      - DISPLAY=:1
      - VNC_PASSWORD=${VNC_PASSWORD:-bisqvnc}
      - TZ=${TZ:-America/Sao_Paulo}
      # User/Group ID mapping (defaults to 1000:1000)
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    stdin_open: true
    tty: true
    restart: unless-stopped
