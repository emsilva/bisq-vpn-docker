services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # VPN testing port
      - 8000:8000
      # Bisq noVNC web interface
      - 6080:6080
      # VNC direct access (optional)
      - 5901:5901
    volumes:
      - ./volumes/gluetun:/gluetun
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ip link show tun0 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Resource limits for VPN container
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=gluetun,component=vpn"
    # Security configuration
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for VPN functionality
      - apparmor:unconfined  # Required for network operations

  bisq:
    image: ghcr.io/emsilva/bisq-vpn-docker:latest
    container_name: bisq
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    volumes:
      # Main Bisq data directory - contains wallet, trade history, tor hidden service, etc.
      - ./volumes/bisq-data:/home/bisq/.local/share/Bisq
      # XFCE and application configs
      - ./volumes/bisq-config:/home/bisq/.config
    environment:
      - DISPLAY=:1
      - VNC_PASSWORD=${VNC_PASSWORD:-bisqvnc}
      - TZ=${TZ:-America/Sao_Paulo}
      # User/Group ID mapping (defaults to 1000:1000)
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    stdin_open: true
    tty: true
    restart: unless-stopped
    # Resource limits for Bisq application container
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "10"
        labels: "service=bisq,component=application"
    # Security configuration
    security_opt:
      - no-new-privileges:true
      # - seccomp=./security/bisq-seccomp.json  # Temporarily disabled for init system compatibility
    # Additional security hardening
    read_only: false  # Cannot be read-only due to Bisq data writes
    tmpfs:
      - /tmp:noexec,nosuid,size=512m
      - /var/tmp:noexec,nosuid,size=256m
